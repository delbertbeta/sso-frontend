# OIDC 服务接入交互说明书

本文档旨在帮助开发者将应用程序接入我们的 OIDC (OpenID Connect) 服务，以实现用户认证和授权。

## 接入流程

整个 OIDC 认证流程遵循标准的授权码模式 (Authorization Code Flow)，主要包含以下几个步骤：

1.  **应用注册**: 在使用 OIDC 服务之前，你需要在我们的开发者中心注册你的应用，并获取唯一的 `client_id` 和 `client_secret`。
2.  **发起授权请求**: 你的应用需要构建一个特定的 URL，并将用户重定向到该 URL 来发起授权请求。
3.  **用户认证与授权**: 用户在我们的认证页面登录并同意授权。
4.  **获取授权码**: 授权成功后，服务会将用户重定向回你的应用，并在 URL 中附带一个授权码 (`code`)。
5.  **交换令牌**: 你的应用后台使用授权码向服务端换取 `id_token` 和 `access_token`。

---

## 步骤一：发起授权请求

你需要将用户重定向到一个构造好的 URL，以启动登录和授权流程。

### 授权端点 URL

```
/auth/login
```

你需要在此 URL 后面拼接一系列查询参数。

### 请求参数

以下是发起授权请求时需要提供的参数：

| 参数            | 类型     | 必填 | 描述                                                                                                                              |
| :-------------- | :------- | :--- | :-------------------------------------------------------------------------------------------------------------------------------- |
| `response_type` | `string` | 是   | OIDC 流程的类型。对于授权码模式，此值必须为 `code`。                                                                              |
| `client_id`     | `string` | 是   | 在开发者中心注册应用后获取的客户端 ID。                                                                                           |
| `redirect_uri`  | `string` | 是   | 用户授权后重定向回你的应用的 URL。此 URL 必须与在开发者中心注册应用时填写的重定向 URL 完全一致。                                      |
| `scope`         | `string` | 是   | 一个以空格分隔的字符串列表，表示你的应用希望获取的权限。必须至少包含 `openid`。其他可选的 scope 包括 `profile`、`email` 等。      |
| `state`         | `string` | 推荐 | 一个随机生成的、不透明的字符串，用于防止 CSRF 攻击。在用户重定向回来时，我们会原样返回此参数，你的应用需要验证其一致性。 |
| `nonce`         | `string` | 推荐 | 一个随机生成的字符串，用于防止重放攻击。此值会包含在最终的 `id_token` 中，你的应用需要验证其一致性。                             |

### 示例 URL

一个完整的授权请求 URL 如下所示：

```
/auth/login?response_type=code&client_id=YOUR_CLIENT_ID&redirect_uri=https://your-app.com/callback&scope=openid%20profile&state=random_state_string&nonce=random_nonce_string
```

---

## 步骤二：处理回调

用户完成认证和授权后，我们会将其重定向回你在 `redirect_uri` 参数中指定的 URL。

### 成功授权

如果用户同意授权，重定向的 URL 中将包含以下参数：

| 参数   | 类型     | 描述                                                       |
| :----- | :------- | :--------------------------------------------------------- |
| `code` | `string` | 授权码，有效期很短（通常为几分钟），只能使用一次。         |
| `state`  | `string` | 你在请求中提供的 `state` 值，你需要验证此值以确保请求的完整性。 |

**成功回调示例**:

```
https://your-app.com/callback?code=AUTHORIZATION_CODE&state=random_state_string
```

### 拒绝授权或发生错误

如果用户拒绝授权或在流程中发生错误，重定向的 URL 中将包含以下参数：

| 参数          | 类型     | 描述                                                       |
| :------------ | :------- | :--------------------------------------------------------- |
| `error`       | `string` | 错误代码，例如 `access_denied` 表示用户拒绝了授权。        |
| `state`       | `string` | 你在请求中提供的 `state` 值，你需要验证此值。                |

**失败回调示例**:

```
https://your-app.com/callback?error=access_denied&state=random_state_string
```

---

## 步骤三：用授权码交换令牌

在你的应用后端，收到授权码 (`code`) 后，你需要向我们的令牌端点发起一个 `POST` 请求，以换取 `id_token` 和 `access_token`。

> **注意**: 令牌交换的细节超出了本前端交互说明书的范围，请参考相应的后端 API 文档。

完成以上步骤后，你的应用便成功通过 OIDC 完成了用户的身份验证。
